<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Usuario conectado</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --ok: #22c55e;
      --ok-700: #16a34a;
      --danger: #ef4444;
      --ring: #34d39933;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: radial-gradient(1200px 800px at 10% -20%, #1f2937, transparent),
                  radial-gradient(900px 600px at 120% 120%, #1e40af, transparent),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .card {
      width: 100%;
      max-width: 740px;
      background: linear-gradient(180deg, #0b1220, #0a0f1a 30%, #0b1220 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px #00000066, inset 0 1px 0 #ffffff0a;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .badge-ok {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      color: #052b18;
      background: linear-gradient(180deg, var(--ok), var(--ok-700));
      box-shadow: 0 6px 16px #16a34a55, inset 0 1px 0 #ffffff36;
      font-weight: 700;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .badge-ok .dot {
      width: 10px; height: 10px; border-radius: 50%; background: #052b18; box-shadow: 0 0 0 3px #052b1822;
    }
    .muted { color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
    .panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: #0b1220;
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 700;
    }
    .kv { display: grid; grid-template-columns: 180px 1fr; gap: 8px 10px; }
    .k { color: #cbd5e1; font-size: 13px; }
    .v { color: var(--text); font-weight: 600; word-break: break-all; }
    .actions {
      display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px;
    }
    button, .link {
      height: 40px; padding: 0 14px; border-radius: 10px; border: 1px solid var(--border);
      background: #0b1220; color: var(--text); font-weight: 700; cursor: pointer;
      transition: border-color .15s ease, box-shadow .15s ease, transform .05s ease;
      text-decoration: none; display: inline-flex; align-items: center; justify-content: center;
    }
    button:hover, .link:hover { border-color: #34d399; box-shadow: 0 0 0 5px var(--ring); }
    button:active { transform: translateY(1px); }
    .danger { border-color: #7f1d1d; color: #fecaca; }
    .status { margin-top: 10px; min-height: 18px; font-size: 13px; color: var(--muted); }
    .status.error { color: var(--danger); }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <main class="card" role="main">
    <div class="header">
      <h1 class="title">
        <span class="badge-ok"><span class="dot"></span> Sesión activa</span>
        <span class="muted">Has iniciado sesión correctamente</span>
      </h1>
      <div class="actions">
        <a class="link" href="/">Inicio</a>
        <a class="link" href="/users/user-test.html">Cambiar de usuario</a>
        <button id="logout-btn" class="danger" type="button">Cerrar sesión</button>
      </div>
    </div>

    <section class="grid">
      <div class="panel">
        <h2>Resumen</h2>
        <div class="kv">
          <div class="k">Usuario</div><div id="u-username" class="v">—</div>
          <div class="k">Email</div><div id="u-email" class="v">—</div>
          <div class="k">Último acceso</div><div id="u-last" class="v">—</div>
          <div class="k">Roles</div><div id="u-roles" class="v">—</div>
        </div>
      </div>

      <div class="panel">
        <h2>Sesión</h2>
        <div class="kv">
          <div class="k">Cookie session_id</div><div id="s-cookie" class="v">—</div>
          <div class="k">Expira</div><div id="s-exp" class="v">—</div>
          <div class="k">IP/Agente</div><div id="s-agent" class="v">—</div>
        </div>
      </div>
    </section>

    <div id="status" class="status" aria-live="polite"></div>
  </main>

  <script>
    (function () {
      const qs = (id) => document.getElementById(id);
      const statusEl = qs('status');

      function setStatus(msg, isError) {
        statusEl.textContent = msg || '';
        statusEl.classList.toggle('error', !!isError);
      }

      function getCookie(name) {
        const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()[\]\\/+^])/g, '\\$1') + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
      }

      function mask(value, keep = 6) {
        if (!value) return '—';
        return value.length <= keep ? value : '••••••' + value.slice(-keep);
      }

      function fmtDate(ts) {
        const d = ts ? new Date(ts) : null;
        return d && !isNaN(d) ? d.toLocaleString() : '—';
      }

      async function loadUser() {
        // 1) Verificar cookie de sesión
        const sid = getCookie('session_id');
        if (!sid) {
          alert('Debes iniciar sesión para acceder a esta página.');
          window.location.href = '/users/user-test.html';
          return;
        }

        // Mostrar info básica de cookie y agente
        qs('s-cookie').textContent = mask(sid, 8);
        qs('s-agent').textContent = navigator.userAgent;

        // 2) Consultar al servidor los datos del usuario
        try {
          const res = await fetch('/me', { credentials: 'include' });
          if (res.status === 401 || res.status === 403) {
            alert('Tu sesión no es válida o ha expirado. Inicia sesión de nuevo.');
            window.location.href = '/users/user-test.html';
            return;
          }
          if (!res.ok) throw new Error('Respuesta no válida');

          // Suponemos JSON: { username, email, last_login, roles, session:{expires_at} }
          const data = await res.json().catch(() => ({}));

          qs('u-username').textContent = data.username || '—';
          qs('u-email').textContent = data.email || '—';
          qs('u-last').textContent = fmtDate(data.last_login);
          qs('u-roles').textContent = Array.isArray(data.roles) && data.roles.length ? data.roles.join(', ') : '—';
          qs('s-exp').textContent = fmtDate(data.session && data.session.expires_at);

          setStatus('Sesión verificada.');
        } catch (e) {
          setStatus('No se pudo obtener la información del usuario.', true);
        }
      }

      async function logout() {
        setStatus('');
        try {
          await fetch('/logout', { method: 'POST', credentials: 'include' });
        } finally {
          window.location.href = '/users/user-test.html';
        }
      }

      qs('logout-btn').addEventListener('click', logout);
      loadUser();
    })();
  </script>
</body>
</html>
