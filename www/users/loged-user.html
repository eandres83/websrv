<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Usuario conectado</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --ok: #22c55e;
      --ok-700: #16a34a;
      --danger: #ef4444;
      --ring: #34d39933;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: radial-gradient(1200px 800px at 10% -20%, #1f2937, transparent),
                  radial-gradient(900px 600px at 120% 120%, #1e40af, transparent),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .card {
      width: 100%;
      max-width: 740px;
      background: linear-gradient(180deg, #0b1220, #0a0f1a 30%, #0b1220 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px #00000066, inset 0 1px 0 #ffffff0a;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .badge-ok {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      color: #052b18;
      background: linear-gradient(180deg, var(--ok), var(--ok-700));
      box-shadow: 0 6px 16px #16a34a55, inset 0 1px 0 #ffffff36;
      font-weight: 700;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .badge-ok .dot {
      width: 10px; height: 10px; border-radius: 50%; background: #052b18; box-shadow: 0 0 0 3px #052b1822;
    }
    .muted { color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
    .panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: #0b1220;
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 700;
    }
    .kv { display: grid; grid-template-columns: 180px 1fr; gap: 8px 10px; }
    .k { color: #cbd5e1; font-size: 13px; }
    .v { color: var(--text); font-weight: 600; word-break: break-all; }
    .actions {
      display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px;
    }
    button, .link {
      height: 40px; padding: 0 14px; border-radius: 10px; border: 1px solid var(--border);
      background: #0b1220; color: var(--text); font-weight: 700; cursor: pointer;
      transition: border-color .15s ease, box-shadow .15s ease, transform .05s ease;
      text-decoration: none; display: inline-flex; align-items: center; justify-content: center;
    }
    button:hover, .link:hover { border-color: #34d399; box-shadow: 0 0 0 5px var(--ring); }
    button:active { transform: translateY(1px); }
    .danger { border-color: #7f1d1d; color: #fecaca; }
    .status { margin-top: 10px; min-height: 18px; font-size: 13px; color: var(--muted); }
    .status.error { color: var(--danger); }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <main class="card" role="main">
    <div class="header">
      <h1 class="title">
        <span class="badge-ok"><span class="dot"></span> Sesión activa</span>
        <span class="muted">Has iniciado sesión correctamente</span>
      </h1>
      <div class="actions">
        <a class="link" href="/">Inicio</a>
        <a class="link" id="change-user-link" href="/users/user-test.html">Cambiar de usuario</a>
        <button id="logout-btn" class="danger" type="button">Cerrar sesión</button>
      </div>
    </div>

    <section class="grid">
      <div class="panel">
        <h2>Resumen</h2>
        <div class="kv">
          <div class="k">Usuario</div><div id="u-username" class="v">—</div>
          <div class="k">Email</div><div id="u-email" class="v">—</div>
          <div class="k">Último acceso</div><div id="u-last" class="v">—</div>
          <div class="k">Roles</div><div id="u-roles" class="v">—</div>
        </div>
      </div>

      <div class="panel">
        <h2>Sesión</h2>
        <div class="kv">
          <div class="k">Cookie session_id</div><div id="s-cookie" class="v">—</div>
          <div class="k">Expira</div><div id="s-exp" class="v">—</div>
          <div class="k">IP/Agente</div><div id="s-agent" class="v">—</div>
        </div>
      </div>
    </section>

    <div id="status" class="status" aria-live="polite"></div>
  </main>

  <script>
    (function () {
      // Solo exigimos username (session_id no es accesible en JS por HttpOnly)
      var requiredCookies = ['username'];
      function hasCookie(name){
        return document.cookie.split(';').some(function(c){ return c.trim().indexOf(name + '=') === 0; });
      }
      for (var i=0;i<requiredCookies.length;++i){
        if (!hasCookie(requiredCookies[i])) {
          window.location.replace('/users/user-test.html');
          return;
        }
      }

      const qs = (id)=>document.getElementById(id);
      const statusEl = qs('status');

      function setStatus(msg,isError){
        statusEl.textContent = msg || '';
        statusEl.classList.toggle('error', !!isError);
      }

      function getCookie(name){
        var m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()[\]\\/+^])/g,'\\$1')+'=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
      }

      // session_id no se puede leer -> muestra marcador
      qs('s-cookie').textContent = 'HttpOnly';
      qs('s-agent').textContent = navigator.userAgent;

      async function loadUser(){
        try {
          const res = await fetch('/me', { credentials:'include' });
          if (res.status === 401 || res.status === 403) {
            window.location.replace('/users/user-test.html');
            return;
          }
          if (!res.ok) throw new Error();
          const data = await res.json().catch(function(){ return {}; });
          qs('u-username').textContent = data.username || getCookie('username') || '—';
          qs('u-email').textContent = data.email || '—';
          qs('u-last').textContent = data.last_login ? new Date(data.last_login).toLocaleString() : '—';
          qs('u-roles').textContent = (data.roles && data.roles.length) ? data.roles.join(', ') : '—';
          qs('s-exp').textContent = (data.session && data.session.expires_at) ? new Date(data.session.expires_at).toLocaleString() : '—';
          setStatus('Sesión verificada.');
        } catch(e){
          setStatus('No se pudo obtener la información del usuario.', true);
        }
      }

      function expireClientCookies() {
        // Borra lo que sí es accesible
        document.cookie = 'username=; Path=/; Max-Age=0';
        // Intento (no tendrá efecto si es HttpOnly, pero no hace daño)
        document.cookie = 'session_id=; Path=/; Max-Age=0';
      }

      async function serverLogout() {
        try {
          await fetch('/logout', { method: 'POST', credentials: 'include' });
        } catch (_) {}
      }

      async function fullLogout(redirectTo) {
        expireClientCookies();
        await serverLogout();
        window.location.replace(redirectTo || '/users/user-test.html');
      }

      async function logout(){
        setStatus('');
        await fullLogout('/users/user-test.html');
      }

      // Interceptar "Cambiar de usuario" para limpiar cookies antes
      var changeLink = document.getElementById('change-user-link');
      changeLink.addEventListener('click', function(e){
        e.preventDefault();
        fullLogout('/users/user-test.html');
      });

      qs('logout-btn').addEventListener('click', logout);
      loadUser();
    })();
  </script>
</body>
</html>
